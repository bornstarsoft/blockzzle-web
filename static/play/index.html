<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Unity Web Player | Blockzzle</title>

  <!-- ✅ FIX: viewport는 JS로 넣지 말고 head에 고정 -->
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <style>
    html,
    body {
      height: 100%;
    }

    body {
      text-align: center;
      padding: 0;
      border: 0;
      margin: 0;
      background: #0b1220;
    }

    /* ✅ Unity canvas 기본 */
    #unity-canvas {
      background: #231f20;
      display: block;
      margin: 0 auto;
      z-index: 0;
      position: relative;
      /* 기본: PC에서는 중앙 */
      width: 540px;
      height: 960px;
    }

    /* Top overlay */
    #bssOverlay {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 100000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      pointer-events: none;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    #bssOverlay * {
      pointer-events: auto;
    }

    .bss-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bss-brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: #fff;
    }

    .bss-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #41c6ff;
      display: inline-block;
    }

    .bss-title {
      font-weight: 800;
      font-size: 14px;
      letter-spacing: -0.02em;
      opacity: 0.95;
    }

    .bss-btn,
    .bss-link {
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(0, 0, 0, 0.22);
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select: none;
    }

    .bss-link {
      color: rgba(255, 255, 255, 0.85);
      font-weight: 600;
    }

    .bss-btn:hover,
    .bss-link:hover {
      border-color: rgba(255, 255, 255, 0.22);
    }

    .bss-primary {
      background: linear-gradient(135deg, #41c6ff, #2dd4bf);
      border-color: transparent;
      color: #06121f;
    }

    @media (max-width: 520px) {
      .bss-title {
        display: none;
      }
    }

    /* ✅ Mobile bottom sticky CTA */
    #bssStickyCta {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 100000;
      display: none;
      /* 기본 숨김 */
      pointer-events: none;
      /* 컨테이너는 터치 막지 않게 */
    }

    #bssStickyCta .bss-sticky-btn {
      height: 52px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      text-decoration: none;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: #06121f;
      background: linear-gradient(135deg, #41c6ff, #2dd4bf);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      pointer-events: auto;
      /* 버튼만 터치 받기 */
    }

    /* ✅ 터치(모바일/태블릿)에서만 스티키 보이기: 폭 기반보다 안정적 */
    @media (hover: none) and (pointer: coarse) {
      #bssStickyCta {
        display: block;
      }

      body {
        padding-bottom: 86px;
      }

      /* 스티키가 내용 가리지 않게 여백 */
    }

    /* ✅ 터치기기에서는 캔버스 꽉 채우기 */
    @media (hover: none) and (pointer: coarse) {
      #unity-canvas {
        width: 100vw;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        margin: 0;
      }

      body {
        text-align: left;
      }
    }
  </style>
</head>

<body>
  <!-- ✅ Top overlay UI -->
  <div id="bssOverlay">
    <div class="bss-left">
      <a class="bss-brand" href="/">
        <span class="bss-dot"></span>
        <span class="bss-title">Blockzzle</span>
      </a>
      <a class="bss-link" href="/">Home</a>
    </div>

    <div class="bss-right" style="display: flex; gap: 10px; align-items: center;">
      <button id="bssFullscreen" class="bss-btn" type="button">Fullscreen</button>
      <a id="bssGetApp" class="bss-btn bss-primary" href="#" target="_blank" rel="noopener">Get the App</a>
    </div>
  </div>

  <!-- ✅ Unity canvas -->
  <canvas id="unity-canvas" width="540" height="960" tabindex="-1"></canvas>

  <!-- ✅ Unity loader -->
  <script src="Build/Blockzzle_v5_web.loader.js"></script>

  <script>
    // ✅ Store URL
    const STORE_URL =
      "https://play.google.com/store/apps/details?id=com.bornstarsoft.matchcolorblocks";

    function withUtm(url, content) {
      try {
        // ✅ 상대경로도 안전하게 처리
        const u = new URL(url, location.origin);
        u.searchParams.set("utm_source", "webgl");
        u.searchParams.set("utm_medium", "cta");
        u.searchParams.set("utm_campaign", "blockzzle_web");
        if (content) u.searchParams.set("utm_content", content);
        return u.toString();
      } catch (e) {
        return url;
      }
    }

    // ✅ UA 기반 모바일 판별 (Fullscreen 버튼 제어용)
    const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // ✅ 버튼 링크 세팅 (DOM 보장)
    window.addEventListener("DOMContentLoaded", () => {
      const stickyPlay = document.getElementById("bssStickyPlay");
      if (stickyPlay) stickyPlay.href = withUtm("/play/", "play_sticky_bottom");

      const getApp = document.getElementById("bssGetApp");
      if (getApp) getApp.href = withUtm(STORE_URL, "play_overlay_top");
    });

    // ✅ Fullscreen 버튼: 모바일에서만 보이게 (PC에서는 숨김)
    const fsBtn = document.getElementById("bssFullscreen");
    if (fsBtn) {
      if (!IS_MOBILE) {
        fsBtn.style.display = "none";
      } else {
        fsBtn.addEventListener("click", async () => {
          try {
            const el = document.getElementById("unity-canvas") || document.body;
            if (el.requestFullscreen) await el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
          } catch (e) {
            console.warn(e);
          }
        });
      }
    }

    // ✅ Unity boot
    createUnityInstance(document.querySelector("#unity-canvas"), {
      arguments: [],
      dataUrl: "Build/Blockzzle_v5_web.data.unityweb",
      frameworkUrl: "Build/Blockzzle_v5_web.framework.js.unityweb",
      codeUrl: "Build/Blockzzle_v5_web.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "BORNSTAR SOFT",
      productName: "Blockzzle",
      productVersion: "5.0.1",
    })
      .then((unityInstance) => {
        window.unityInstance = unityInstance;
      })
      .catch((message) => {
        alert(message);
      });

    // ✅ WebAudio 잠금 해제: 최초 유저 제스처 1회에만 resume
    function resumeWebAudioOnce() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;

        const ctx = window.__bssAudioCtx || (window.__bssAudioCtx = new AC());
        if (ctx.state === "suspended") ctx.resume().catch(() => { });
      } catch (e) { }

      window.removeEventListener("pointerdown", resumeWebAudioOnce);
      window.removeEventListener("touchstart", resumeWebAudioOnce);
      window.removeEventListener("mousedown", resumeWebAudioOnce);
      window.removeEventListener("keydown", resumeWebAudioOnce);
    }

    window.addEventListener("pointerdown", resumeWebAudioOnce, { once: true });
    window.addEventListener("touchstart", resumeWebAudioOnce, { once: true });
    window.addEventListener("mousedown", resumeWebAudioOnce, { once: true });
    window.addEventListener("keydown", resumeWebAudioOnce, { once: true });
  </script>

  <!-- ✅ Mobile sticky CTA (Play Now) -->
  <div id="bssStickyCta" aria-label="Play Blockzzle demo">
    <a id="bssStickyPlay" class="bss-sticky-btn" href="/play/">▶ Play Now</a>
  </div>
</body>

</html>